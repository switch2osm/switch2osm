---
layout: docs
title: Створення тайлового сервера вручну (Ubuntu 18.04 LTS)
dist: Ubuntu 18.04
dl_timestamp: "2017-02-26T21:43:02Z"
lang: uk
---

# {{ title }}

!!! info ""
    На цій сторінці міститься опис зі встановлення, розгортання та налаштування всього потрібного програмного забезпечення для роботи вашого тайлового сервера. Покрокові інструкції описують встановлення тайлового сервера на [Ubuntu Linux](https://ubuntu.com/){: target=_blank} 18.04 LTS (Bionic Beaver), вони були перевірені у травні 2020.

## Встановлення програмного забезпечення

Тайловий сервер OpenStreetMap&nbsp;– це набір програмного забезпечення та бібліотек, які працюють разом генеруючи тайли. Як це трапляється доволі часто в OpenStreetMap, існує кілька різних шляхів для досягнення мети і майже кожен компонент має альтернативу, з власними недоліками та перевагами. Цей посібник описує найбільш стандартну версію, що схожа на те, що використовується головним тайловим сервером OpenStreetMap.

Тайловий сервер складається з пʼяти головних частин: `mod_tile`, `renderd`, `mapnik`, `osm2pgsql` та база даних `postgresql/postgis`. Mod_tile&nbsp;– модуль сервера Apache, який обслуговує тайловий кеш та визначає які тайли потрібно перегенерувати, через їх відсутність у кеші або тому, що вони застаріли. Renderd визначає пріоритети в чергах різного штибу запитів для згладжування навантаження. Mapnik&nbsp;– бібліотека, яка відповідає безпосередньо за створення тайлів з черги, якою керує renderd.

Зауважте, що це керівництво було написане та протестоване з використанням нововстановленого сервера з операційною системою {{ dist }}. Якщо у вас встановлені інші версії програмного забезпечення (можливо ви оновились з попередньої версії Ubuntu, або у вас підʼєднані інші репозиторії PPA), можливо вам доведеться внести певні зміни.

Керівництво передбачає, що ви виконуєте всі команди в оточені звичайного користувача за допомогою команди `sudo`. Нижче ви побачите нікнейм такого користувача `renderaccount`&nbsp;– ви можете створити його так само, або змінити наведені скрипти, щоб вони працювали від імені вашого користувача. Якщо ви створите у себе користувача `renderaccount`, вам буде потрібно додати його в групу, яка має дозвіл на використання команди `sudo`, для цього з оточення звичайного користувача виконайте наступні команди:

```sh
sudo -i
usermod -aG sudo renderaccount
exit
```

Для того, щоб створити всі ці компоненти, вам спочатку треба встановити наступні залежності:

```sh
--8<-- "docs/assets/serving-tiles/ubuntu-18-04-deps.txt"
```

Скажіть Так на запит системи про початок встановлення. Це триватиме доволі довго, тож у вас є час на філіжанку кави. Цей перелік містить різноманітні утиліти, наприклад, вебсервер Apache, компілятор "carto", що використовується для конвертації стилів Carto-CSS в зрозумілий для "mapnik" вигляд. Коли закінчиться встановлення цієї частини, встановіть наступний набір потрібних компонентів:

## Встановлення postgresql / postgis

Ubuntu має спаковані версії `postgis` і `postgresql`, тож вони можуть бути легко встановлені з допомогою менеджера пакунків Ubuntu.

```sh
sudo apt-get install \
    postgresql \
    postgresql-contrib \
    postgis \
    postgresql-10-postgis-2.4 \
    postgresql-10-postgis-scripts
```

Тут `postgresql` це сервер баз даних, який ми збираємось встановити для зберігання наших даних, а `postgis` додає йому підтримку роботи з геопросторовими даними. То ж знов, скажіть Так для встановлення.

Тепер вам треба створити базу даних з підтримкою postgis. Типові налаштування різноманітних програм очікують що база даних називатиметься `gis`, тож ми будемо дотримуватись цієї угоди в цім керівництві, хоча це й не обовʼязково. Замініть тут, і далі нижче, `renderaccount` на імʼя користувача під яким буде відбуватись генерування тайлів за допомогою Mapnik.

```sh
sudo -u postgres -i
createuser renderaccount
createdb -E UTF8 -O renderaccount gis
```

Поки ви працюєте як користувач `postgres`, встановіть PostGIS в базу даних PostgreSQL (знову, замініть `renderaccount` на вашого користувача нижче):

```sh
psql
```

(це призведе до появи `postgres=#` на початку рядка консолі)

```sh
\c gis
```

(у відповідь ви побачите: "You are now connected to database 'gis' as user 'postgres'" <br/>\["Тепер ви підʼєднані до бази даних 'gis' як користувач 'postgres'"\])

```sql
CREATE EXTENSION postgis;
```

(у відповідь ви побачите: CREATE EXTENSION)

```sql
CREATE EXTENSION hstore;
```

(у відповідь ви побачите: CREATE EXTENSION)

```sql
ALTER TABLE geometry_columns OWNER TO renderaccount;
```

(у відповідь ви побачите: ALTER TABLE)

```sql
ALTER TABLE spatial_ref_sys OWNER TO renderaccount;
```

(у відповідь ви побачите: ALTER TABLE)

```sh
\q
```

(це призведе до виходу з сесії psql та повернення назад у консоль Linux)

```sh
exit
```

(повернення назад до сесії користувача, в якій ми знаходились до виконання команди `sudo -u postgres -i` вище)

Якщо ви ще цього не зробили, створіть обліковий запис для вашого користувача, введіть пароль коли це буде запропоновано:

```sh
sudo useradd -m renderaccount
sudo passwd renderaccount
```

Знов, замініть `renderaccount` імʼям користувача без адміністративних повноважень на ваш смак.

### Встановлення osm2pgsql

Тепер нам треба встановити деяке програмне забезпечення з сирців. Перше, це `osm2pgsql`. Для імпорту та керування даними OpenStreetMap в базі даних існують різні інструменти. Ми будемо використовувати `osm2pgsql`, це найпопулярніший інструмент серед інших.

```sh
mkdir ~/src
cd ~/src
git clone https://github.com/openstreetmap/osm2pgsql
cd osm2pgsql
```

Механізм збирання, що використовується для osm2pgsql, трохи змінився з часом і нам доведеться встановити кілька залежностей:

```sh
--8<-- "docs/assets/serving-tiles/ubuntu-18-04-osm2pgsql-deps.txt"
```

Знов, скажіть Так для встановлення.

```sh
mkdir build && cd build
cmake ..
```

(в результаті ви маєте отримати повідомлення "build files have been written to"/"створені файли були записані в")

```sh
make
```

(вивід має закінчуватись рядком "\[100%\] Built target osm2pgsql"/"\[100%\] Створення osm2pgsql")

```sh
sudo make install
```

## Mapnik

Далі, ми встановимо Mapnik. Ми будем використовувати типову версію з {{ dist }}:

```sh
--8<-- "docs/assets/serving-tiles/ubuntu-18-04-mapnik-deps.txt"
```

Перевіримо чи Mapnik встановлено правильно:

```py
python
>>> import mapnik
>>>
```

Якщо python у відповідь видає тільки `>>>` без повідомлення про помилки, значить бібліотека Mapnik є доступною в Python. Вітаємо! Для виходу із сесії Python скористайтесь наступною командою:

```py
>>> quit()
```

## Встановлення mod_tile та renderd

Далі, ми встановимо mod_tile та renderd. `mod_tile`&nbsp;– модуль Apache, який обробляє запити на показ тайлів; `renderd`&nbsp;– фонова служба, яка відповідає за генерацію тайлів на запит `mod_tile`. Ми будемо використовувати гілку `switch2osm` з <https://github.com/SomeoneElseOSM/mod_tile>{: target=_blank}, яка своєю чергою базується на коді <https://github.com/openstreetmap/mod_tile>{: target=_blank}, але змінена таким чином, щоб працювати на {{ dist }}, також вона містить пару інших змін потрібних для роботи зі стандартним сервером на Ubuntu на відміну від того, що використовується на тайлових серверах OpenStreetMap.

### Компіляція mod_tile з сирців

```sh
cd ~/src
git clone -b switch2osm git://github.com/SomeoneElseOSM/mod_tile.git
cd mod_tile
./autogen.sh
```

(виконання має закінчитись повідомленням `autoreconf: Leaving directory '.'`.)

```sh
./configure
```

(має закінчитись повідомленням `config.status: executing libtool commands`)

```sh
make
```

Зауважте, що деякі "попереджувальні" повідомлення будуть зʼявлятись на екрані. Проте все має закінчитись повідомленням "make\[1\]: Leaving directory '/home/renderaccount/src/mod_tile'".

```sh
sudo make install
```

(має закінчитись повідомленням "make\[1\]: Leaving directory '/home/renderaccount/src/mod_tile'")

```sh
sudo make install-mod_tile
```

(має закінчитись повідомленням "chmod 644 /usr/lib/apache2/modules/mod_tile.so")

```sh
sudo ldconfig
```

(тут немає бути жодного повідомлення)

## Налаштування стилів

Тепер, після того, як все потрібне програмне забезпечення встановлене, вам треба завантажити та налаштувати стилі.

Стиль, який ми будемо використовувати,&nbsp;– це стиль який застосовується для створення "Стандартного" шару на сайті openstreetmap.org. Ми обрали його через гарну документацію і те, що він здатен працювати для будь-якої частини світу, навіть там де не використовується латинка. Але у нього є й певні недоліки&nbsp;– це компромісні рішення для того, щоб працювати в глобальних масштабах, він дуже складний для розуміння та внесення змін, якщо вам доведеться їх вносити.

Код стилю "OpenStreetMap Carto" з веб-сайту openstreetmap.org знаходиться на GitHub&nbsp;– <https://github.com/gravitystorm/openstreetmap-carto/>{: target=_blank} та також має власні інструкції зі встановлення&nbsp;– <https://github.com/gravitystorm/openstreetmap-carto/blob/master/INSTALL.md>{: target=_blank}. Про те, що потрібно зробити, ми розповімо тут.

Передбачається що ми розміщуємо стиль в теці `~/src` домашньої директорії користувача `renderaccount` (або будь-якого іншого, якого ви створили до цього)

```sh
cd ~/src
git clone https://github.com/gravitystorm/openstreetmap-carto
cd openstreetmap-carto
```

Далі, встановимо потрібну версію компілятора `carto`. Це більш свіжа версія, ніж та що є в Ubuntu, тож нам потрібно зробити наступне:

```sh
sudo apt-get install nodejs-dev node-gyp libssl1.0-dev
```

Як це не дивно, це призведе до видалення деяких раніше встановлених речей. Потім зробіть:

```sh
sudo apt install npm nodejs
sudo npm install -g carto
carto -v
```

У відповідь ми маємо отримати інформацію про номер версії, яка має бути не менше ніж:

```sh
carto 1.2.0 (Carto map stylesheet compiler)
```

Після цього ми перетворимо проєкт carto у зрозумілий для Mapnik вигляд:

```sh
carto project.mml > mapnik.xml
```

Тепер у нас є стиль Mapnik XML&nbsp;– `/home/renderaccount/src/openstreetmap-carto/mapnik.xml`.

## Завантаження даних

Для початку, завантажимо невеличку частину тестових даних. Серед різномаїття місць для отримання даних, оберемо `download.geofabrik.de`, що містить великий перелік різних варіантів для завантаження. Візьмімо для прикладу Азербайджан (~32.4 Мб).

Перейдіть за посиланням <https://download.geofabrik.de/asia/azerbaijan.html>{: target=_blank} та зверніть увагу на дату "This file was last modified" (щось схоже на "{{ dl_timestamp }}"). Вона нам знадобиться потім, коли у нас виникне потреба оновити наші дані даними, які учасники OpenStreetMap додали з моменту нашого імпорту. Завантажимо дані:

```sh
mkdir ~/data
cd ~/data
wget https://download.geofabrik.de/asia/azerbaijan-latest.osm.pbf
```

Наступна команда допоможе вам перенести завантажені дані до вашої бази даних. На цьому етапі зросте навантаження на дискові операції через потребу перенесення значного обсягу інформації; імпорт всієї планети може тривати кілька годин, днів та навіть тижнів, в залежності від потужностей вашого серверного обладнання. Зрозуміло, що для невеликих частин даних імпорт відбувається значно швидше, можливо вам доведеться поекспериментувати зі значенням параметра `-C`, щоб вкластись у наявну оперативну памʼять вашого сервера.

```sh
osm2pgsql -d gis --create --slim  -G --hstore \
    --tag-transform-script \
        ~/src/openstreetmap-carto/openstreetmap-carto.lua \
    -C 2500 --number-processes 1 \
    -S ~/src/openstreetmap-carto/openstreetmap-carto.style \
    ~/data/azerbaijan-latest.osm.pbf
```

Розберімося що означають всі ці параметри:

`-d gis`
: База даних, з якою ми працюємо (типово використовується "gis"; тут треба вказати її явно).

`--create`
: Завантажити дані в пусту базу даних, замість спроб додати їх до наявних.

`--slim`
: osm2pgsql може використовувати різноманітні схеми таблиць; "slim" годиться для генерації тайлів.

`-G`
: Визначає, яким чином будуть оброблятись мультиполігони.

`--hstore`
: Дозволяє використовувати для генерації тайлів теґи, для яких немає окремих стовпців в базі даних.

`--tag-transform-script ~/src/openstreetmap-carto/openstreetmap-carto.lua`
: Визначає скрипт lua, який використовується для обробки теґів. Це простий спосіб обробки теґів OSM до того, як вони будуть використані в стилі, що спрощує логіку самого стилю.

`-C 2500`
: Виділяє 2.5 Гб оперативної памʼяті для osm2pgsql на виконання імпорту. Якщо у вас менше оперативної памʼяті, спробуйте менше значення. Якщо процес імпорту буде знищений через нестачу оперативної памʼяті, спробуйте зменшити це число або використовуйте менший обсяг даних.

`--number-processes 1`
: Використовувати одне ядро процесора. Якщо у вас багатоядерний процесор можете використовувати більшу кількість ядер.

`-S ~/src/openstreetmap-carto/openstreetmap-carto.style`
: Створювати стовпці в базі даних використовуючи вказаний файл (в нашому випадку він нічим не відрізняється від стандартного "openstreetmap-carto")

`~/data/azerbaijan-latest.osm.pbf`
: Останній аргумент&nbsp;– це файл з даними для завантаження в базу.

Результатом роботи цієї команди має бути щось схоже на "Osm2pgsql took 238s overall".

### Завантаження Shapefile

Незважаючи на те, що більшість даних для створення мапи береться з файлу з даними OpenStreetMap, який ви завантажили раніше, деякі файли в форматі shapefile все ж такі потрібні для таких речей, наприклад, як кордони країн на великих масштабах. Для їх отримання та індексації зробіть:

```sh
cd ~/src/openstreetmap-carto/
scripts/get-external-data.py
```

Цей процес вимагає завантаження великої порції даних та триватиме деякий час без будь-яких помітних змін на екрані. Він фактично робить запис у підтеку "data" в "openstreetmap-carto".

### Шрифти

Починаючи з версії v5.6.0 шрифти для Carto потрібно встановити вручну:

```sh
cd ~/src/openstreetmap-carto/
scripts/get-fonts.sh
```

Наші тестові дані (Азербайджан) були обрані через їх невеликий обсяг, а також через те, що армянська писемність використовує власну абетку.

## Налаштування веб-сервера

### Конфігурація renderd

Налаштування `renderd` знаходяться у файлі `/usr/local/etc/renderd.conf`. Відредагуємо його за допомогою текстового редактора, такого як nano:

```sh
sudo nano /usr/local/etc/renderd.conf
```

Нам потрібно змінити пару рядків. В розділі `renderd`:

```ini
num_threads=4
```

Якщо у вас десь 2 Гб оперативної памʼяті, можливо вам доведеться зменшити цей параметр до 2. Розділ `ajt` відповідає за "іменований стиль мапи" з назвою `ajt`. Ви можете мати більше ніж один такий розділ, якщо треба, за умови, що у них будуть різні URI. Рядок `XML` треба буде змінити на кшталт:

```ini
XML=/home/renderaccount/src/openstreetmap-carto/mapnik.xml
```

Звісно, потрібно буде замінити `renderaccount` на користувача, якого ви створили в системі до цього.

```ini
URI=/hot/
```

Цей параметр було обрано для того щоби було простіше використовувати ваші тайли замість шару Humanitarian з сайту OpenStreetMap.org. Ви можете вказати щось інше, але `/hot/` також годиться.

### Конфігурація Apache

```sh
sudo mkdir /var/lib/mod_tile
sudo chown renderaccount /var/lib/mod_tile
```

```sh
sudo mkdir /var/run/renderd
sudo chown renderaccount /var/run/renderd
```

Тепер нам треба вказати Apache, що нам треба використовувати `mod_tile`, відкриємо nano (або інший редактор):

```sh
sudo nano /etc/apache2/conf-available/mod_tile.conf
```

Додайте наступний рядок у файл:

```ini
LoadModule tile_module /usr/lib/apache2/modules/mod_tile.so
```

збережіть його та виконайте команду:

```sh
sudo a2enconf mod_tile
```

У відповідь ви побачите, що вам треба перезапустити сервіс apache командою `service apache2 reload` для активації нових налаштувань; але ми не будемо робити цього зараз.

Зараз нам треба підʼєднати `renderd` до Apache. За допомогою nano (або іншого редактора):

```sh
sudo nano /etc/apache2/sites-available/000-default.conf
```

Додайте наступне між рядками `ServerAdmin` та `DocumentRoot`:

```ini
LoadTileConfigFile /usr/local/etc/renderd.conf
ModTileRenderdSocketName /var/run/renderd/renderd.sock
# Час очікування, перш ніж відмовитись від генерації тайлу
ModTileRequestTimeout 0
# Час очікування, перш ніж відмовитись від генерації відсутнього тайлу
ModTileMissingRequestTimeout 30
```

І перезапустіть apache двічі:

```sh
sudo service apache2 reload
sudo service apache2 reload
```

(Є підозри, що Apache трохи "підтуплює" під час зміни налаштувань на ходу, тож на всяк випадок це треба зробити двічі).

Якщо ви перейдете в оглядачі на: `http://ip.вашого.сервера/index.html`, ви маєте побачити стандартну сторінку apache в Ubuntu&nbsp;– "It works!".

!!! tip "Порада"
    якщо ви не знаєте IP адресу призначену серверу, її можна дізнатись за допомогою команди `ifconfig`&nbsp;– якщо мережеві налаштування не надто складні, то це має бути щось типу `inet addr` відмінне від `127.0.0.1`.

Якщо ви використовуєте сервер постачальника послуг хостингу, то, швидше за все, внутрішня адреса вашого сервера буде відрізнятися від зовнішньої адреси, яка була надана вам, але ця зовнішня IP-адреса вже буде надіслана вам, і, ймовірно, ви її використовуєте зараз для доступу до сервера.

Зауважте, що це лише сайт `http` (порт 80)&nbsp;– вам потрібно витратити трохи більше часу для налаштування Apache на використання `https`, але це виходить за межі цих інструкцій. Однак якщо ви використовуєте "Let's Encrypt" для отримання сертифікатів, інструкція зі встановлення може також містити поради щодо налаштування сайту Apache для використання https.

### Перший запуск renderd

Далі, нам треба запустити `renderd`, щоб спробувати згенерувати кілька тайлів. Спочатку ми запустимо його так, щоб ми мали змогу відстежити появу помилок:

```sh
renderd -f -c /usr/local/etc/renderd.conf
```

Ви можете побачити кілька попереджень, але не турбуйтеся про це. Головне, щоб не було помилок. В разі появи помилок, збережіть повний вивід, наприклад на pastebin, та зверніться по допомогу, наприклад, на [`community.openstreetmap.org`](https://community.openstreetmap.org){: target=_blank} (дайте посилання на pastebin&nbsp;– не включайте весь вивід до питання).

Відкрийте у себе в оглядачі посилання: `http://ip.вашого.сервера/hot/0/0/0.png`

Ви маєте побачити мапу світу у вашому оглядачі та кілька повідомлень в терміналі, включаючи "DEBUG: START TILE" та "DEBUG: DONE TILE". Не звертайте уваги на повідомлення "DEBUG: Failed to read cmd on fd"&nbsp;– це не помилка. Якщо ви не побачили цього тайлу та отримали інші помилки, знов, збережіть вивід на pastebin та зверніться за допомогою, наприклад на [`community.openstreetmap.org`](https://community.openstreetmap.org){: target=_blank}.

Якщо все працює, натисніть ++control+c++ для зупинки процесу генерації тайлів.

### Запуск renderd в фоновому режимі

Далі ми налаштуємо `renderd` для роботи в фоновому режимі. По-перше, змініть файл `~/src/mod_tile/debian/renderd.init` та вкажіть у "RUNASUSER" того користувача, якого ви створили до цього, замість `renderaccount`, потім скопіюйте його до теки system:

```sh
nano ~/src/mod_tile/debian/renderd.init
sudo cp ~/src/mod_tile/debian/renderd.init /etc/init.d/renderd
sudo chmod u+x /etc/init.d/renderd
sudo cp ~/src/mod_tile/debian/renderd.service /lib/systemd/system/
```

Файл `renderd.service`&nbsp;– це файл системної служби `systemd`. Версія зазначена тут використовує команди init. Щоб переконатись що команда запуску відпрацьовує, запустіть:

```sh
sudo /etc/init.d/renderd start
```

(маєте отримати відповідь&nbsp;– "\[ ok \] Starting renderd (via systemctl): renderd.service".)

Для автоматичного запуску кожного разу, ввімкніть renderd командою:

```sh
sudo systemctl enable renderd
```

## Перегляд тайлів

Для того, щоб побачити тайли, ми трохи змахлюємо користуючись файлом `sample_leaflet.html` з теки “extras” в mod_tile. Просто відкрийте цей файл у вебоглядачі на компʼютері де ви встановили тайловий сервер. Якщо це не можливо&nbsp;– ви встановили тайл-сервер на сервері де немає вебоглядача, ви можете замінити `127.0.0.1` на IP адресу сервера, після чого скопіюйте його в `/var/www/html`.

Через ssh-зʼєднання виконайте команду:

```sh
tail -f /var/log/syslog | grep " TILE "
```

(зверніть увагу на пробіли довкола `" TILE "`)

У відповідь ви отримуватимете по рядку кожного разу, коли буде приходити запит на показ тайлів, або буде закінчуватись їх створення.

Під час завантаження сторінки ви маєте побачити кілька запитів на показ тайлів. Віддаляйтесь поступово. Ви побачите, запити на нові тайли зʼявлятимуться у вашому ssh-зʼєднанні. Деякі тайли на крупних масштабах вимагають багато часу на створення (кілька хвилин) першого разу, але після того, як вони будуть створені, вони будуть доступні для показу миттєво.

Вітаємо! Тепер ви можете повернутись до розділу [Використання тайлів](/using-tiles/) для додавання мапи, що використовує ваш новий тайловий сервер.
